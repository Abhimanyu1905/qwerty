<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicken World - Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#ef4f5f',
                            dark: '#1c1c1c',
                            gray: '#f5f5f5'
                        }
                    }
                }
            }
        }

    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
</head>

<body class="bg-gray-50 pb-20">

    <!-- Navbar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-brand-red flex items-center gap-2 cursor-pointer"
                onclick="switchView('home')">
                <span class="material-icons-round">restaurant_menu</span> Chicken World
            </h1>

            <!-- Navigation Links -->
            <div class="hidden md:flex items-center gap-6">
                <button onclick="switchView('home')" id="nav-home"
                    class="text-brand-red font-bold transition">Home</button>
                <button onclick="switchView('track')" id="nav-track"
                    class="text-gray-500 hover:text-brand-red font-medium transition">Track Order</button>
                <button onclick="switchView('orders')" id="nav-orders"
                    class="text-gray-500 hover:text-brand-red font-medium transition">Order History</button>


            </div>

            <div class="flex items-center gap-4">
                <span id="userDisplayName" class="hidden md:block font-semibold text-gray-700"></span>
                <div class="relative cursor-pointer" onclick="toggleCart()">
                    <span class="material-icons-round text-3xl text-gray-700">shopping_cart</span>
                    <span id="cartCount"
                        class="absolute -top-1 -right-1 bg-brand-red text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                </div>
                <button onclick="logout()" class="text-gray-500 hover:text-brand-red font-medium">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Home View -->
    <div id="homeView">
        <!-- Hero Section -->
        <header
            class="bg-brand-red text-white py-12 px-4 text-center rounded-b-3xl mb-8 shadow-lg relative overflow-hidden">
            <div
                class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/food.png')]">
            </div>
            <div class="relative z-10">
                <h2 class="text-4xl font-bold mb-2">Craving Chicken?</h2>
                <p class="text-lg opacity-90">Order your favorites now!</p>

                <!-- Search Bar -->
                <div class="mt-6 max-w-lg mx-auto relative">
                    <input type="text" id="searchInput" oninput="renderMenu()" placeholder="Search for dishes..."
                        class="w-full pl-12 pr-4 py-3 rounded-full text-gray-800 shadow-lg focus:outline-none focus:ring-2 focus:ring-brand-red">
                    <span class="material-icons-round absolute left-4 top-3 text-gray-400">search</span>
                </div>
            </div>
        </header>

        <!-- Menu Grid -->
        <div class="container mx-auto px-4">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Our Menu</h3>
            <div id="menuGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Items injected by JS -->
            </div>
        </div>
    </div>


    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-end">
        <div class="bg-white w-full max-w-md h-full shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full"
            id="cartContent">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="material-icons-round text-brand-red">shopping_bag</span> Your Cart
                </h2>
                <button onclick="toggleCart()" class="text-gray-500 hover:text-red-500">
                    <span class="material-icons-round">close</span>
                </button>
            </div>

            <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Cart Items -->
            </div>

            <div class="p-4 border-t bg-gray-50">
                <div class="flex justify-between items-center mb-4 text-lg font-bold">
                    <span>Total:</span>
                    <span id="cartTotal" class="text-brand-red">₹0.00</span>
                </div>
                <button onclick="placeOrder()"
                    class="w-full bg-brand-red text-white py-3 rounded-xl font-bold hover:bg-red-600 transition shadow-lg">
                    Place Order
                </button>
            </div>
        </div>
    </div>

    <!-- Track Order View -->
    <div id="trackOrderView" class="hidden">
        <div class="container mx-auto px-4 mt-8 mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Track Your Orders</h3>
            <div id="trackOrderList" class="space-y-4">
                <div class="text-center text-gray-400 py-4">No active orders</div>
            </div>
        </div>
    </div>

    <!-- Orders View -->
    <div id="ordersView" class="hidden">
        <!-- Your Orders Section -->
        <div class="container mx-auto px-4 mt-8 mb-12">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Your Order History</h3>
            <div id="ordersList" class="space-y-4">
                <div class="text-center text-gray-400 py-4">No past orders</div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script type="module">
        import { auth, onAuthStateChanged, signOut } from './firebase-config.js';
        import { getFoodItems, placeOrder as placeOrderService, getOrders } from './db-service.js';

        window.logout = () => {
            signOut(auth).then(() => window.location.href = 'index.html');
        };

        window.switchView = (viewName) => {
            // Hide all views
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('trackOrderView').classList.add('hidden');
            document.getElementById('ordersView').classList.add('hidden');

            // Remove active class from nav items
            const navs = ['nav-home', 'nav-track', 'nav-orders'];
            navs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('text-brand-red', 'font-bold');
                    el.classList.add('text-gray-500');
                }
            });

            // Show selected view and update nav
            if (viewName === 'home') {
                document.getElementById('homeView').classList.remove('hidden');
                document.getElementById('nav-home').classList.add('text-brand-red', 'font-bold');
                document.getElementById('nav-home').classList.remove('text-gray-500');
            } else if (viewName === 'track') {
                document.getElementById('trackOrderView').classList.remove('hidden');
                document.getElementById('nav-track').classList.add('text-brand-red', 'font-bold');
                document.getElementById('nav-track').classList.remove('text-gray-500');
            } else if (viewName === 'orders') {
                document.getElementById('ordersView').classList.remove('hidden');
                document.getElementById('nav-orders').classList.add('text-brand-red', 'font-bold');
                document.getElementById('nav-orders').classList.remove('text-gray-500');
            }
        };

        (async function () {
            // Wait for Auth
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                console.log("Client logged in:", user.email);

                // Display Name
                const nameSpan = document.getElementById('userDisplayName');
                if (nameSpan) nameSpan.innerText = `Hi, ${user.displayName || 'Foodie'}`;

                // Initialize App Data
                await initClientApp(user);

                // Auto-seed for demo if empty
                import('./db-service.js').then(async (module) => {
                    const items = await module.getFoodItems();
                    if (items.length === 0) {
                        const DEFAULT_ITEMS = [
                            { name: 'Whole Chicken', price: 150, image: 'https://images.unsplash.com/photo-1587593810167-a6492031e5fd?w=800&q=80', rating: 4.5 },
                            { name: 'Chicken Breast', price: 220, image: 'https://images.unsplash.com/photo-1604503468506-a8da13d82791?w=800&q=80', rating: 4.8 },
                            { name: 'Spicy Wings', price: 300, image: 'https://images.unsplash.com/photo-1567620832903-9fc6debc209f?w=800&q=80', rating: 4.2 },
                            { name: 'Drumsticks', price: 180, image: 'https://images.unsplash.com/photo-1588723205383-206ae91302b4?w=800&q=80', rating: 4.6 }
                        ];
                        await module.seedDatabase(DEFAULT_ITEMS);
                        renderMenu(); // Refresh
                    }
                });
            });

            // --- App Logic ---
            let cart = {};
            let currentUser = null;

            async function initClientApp(user) {
                currentUser = user;
                loadCart(); // Keep cart local for now
                await renderMenu();
                await renderOrders();

                // Auto refresh orders every 10 seconds
                setInterval(renderOrders, 10000);
                // Auto refresh menu every 5 seconds (to catch admin updates)
                setInterval(renderMenu, 5000);
            }

            // Cart Logic (Local Storage)
            window.loadCart = function () {
                const allCarts = JSON.parse(localStorage.getItem('cart')) || {};
                cart = allCarts[currentUser.uid] || {};
                updateCartUI();
            }

            window.saveCart = function () {
                const allCarts = JSON.parse(localStorage.getItem('cart')) || {};
                allCarts[currentUser.uid] = cart;
                localStorage.setItem('cart', JSON.stringify(allCarts));
                updateCartUI();
            }

            // Menu Logic (Firestore)
            window.renderMenu = async function () {
                const search = document.getElementById('searchInput').value.toLowerCase();
                const grid = document.getElementById('menuGrid');
                if (!grid.innerHTML.includes('Loading')) {
                    // Only show loading if empty, otherwise silent update
                    if (grid.children.length === 0) grid.innerHTML = '<p class="col-span-full text-center py-10">Loading menu...</p>';
                }

                try {
                    const items = await getFoodItems();
                    console.log("Fetched items:", items);

                    if (items.length === 0) {
                        grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">No items found.</p>';
                        return;
                    }

                    const filtered = items.filter(item => item.name.toLowerCase().includes(search));

                    grid.innerHTML = filtered.map(item => `
                    <div class="bg-white rounded-2xl shadow hover:shadow-xl transition duration-300 overflow-hidden group">
                        <div class="relative h-48 overflow-hidden">
                            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                            <div class="absolute top-2 right-2 bg-white px-2 py-1 rounded-lg shadow text-xs font-bold flex items-center gap-1">
                                <span class="text-yellow-500 material-icons-round text-sm">star</span> ${item.rating}
                            </div>
                        </div>
                        <div class="p-4">
                            <h4 class="font-bold text-lg text-gray-800 mb-1 truncate">${item.name}</h4>
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-xl font-bold text-brand-red">₹${item.price}</span>
                                <button onclick="addToCart('${item.id}', '${item.name}', '${item.image}', ${item.price})" class="bg-brand-red text-white p-2 rounded-full shadow-lg hover:bg-black transition active:scale-95">
                                    <span class="material-icons-round text-sm">add</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                    // Expose items globally
                    window.currentItems = items;

                } catch (e) {
                    console.error("Error rendering menu:", e);
                    grid.innerHTML = `<p class="col-span-full text-center text-red-500 py-10">Error loading menu: ${e.message}</p>`;
                }
            }

            window.addToCart = function (id, name, image, price) {
                console.log("addToCart called:", id, name, price);
                try {
                    if (!currentUser) {
                        alert("Please wait, logging in...");
                        return;
                    }
                    if (cart[id]) {
                        cart[id].quantity++;
                    } else {
                        cart[id] = { id, name, image, price, quantity: 1 };
                    }
                    saveCart();
                    showToast('Added to cart!');
                } catch (e) {
                    console.error("addToCart Error:", e);
                    alert("Error adding to cart: " + e.message);
                }
            }

            window.removeFromCart = function (id) {
                delete cart[id];
                saveCart();
            }

            window.updateQuantity = function (id, change) {
                if (cart[id].quantity + change <= 0) {
                    removeFromCart(id);
                } else {
                    cart[id].quantity += change;
                    saveCart();
                }
            }

            window.updateCartUI = function () {
                const cartItems = document.getElementById('cartItems');
                const cartTotal = document.getElementById('cartTotal');
                const cartCount = document.getElementById('cartCount');

                let total = 0;
                let count = 0;
                const entries = Object.values(cart);

                if (entries.length === 0) {
                    cartItems.innerHTML = '<div class="text-center text-gray-400 py-10 flex flex-col items-center"><span class="material-icons-round text-4xl mb-2">remove_shopping_cart</span>Empty Cart</div>';
                } else {
                    cartItems.innerHTML = entries.map(item => {
                        total += item.price * item.quantity;
                        count += item.quantity;
                        return `
                        <div class="flex items-center gap-3 bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                            <img src="${item.image}" class="w-16 h-16 rounded-lg object-cover">
                            <div class="flex-1">
                                <h4 class="font-bold text-sm text-gray-800">${item.name}</h4>
                                <p class="text-brand-red font-bold text-xs">₹${item.price}</p>
                            </div>
                            <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                                <button onclick="updateQuantity('${item.id}', -1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow text-gray-600 hover:text-green-500">-</button>
                                <span class="text-xs font-bold w-4 text-center">${item.quantity}</span>
                                <button onclick="updateQuantity('${item.id}', 1)" class="w-6 h-6 flex items-center justify-center bg-white rounded shadow text-gray-600 hover:text-green-500">+</button>
                            </div>
                        </div>
                    `}).join('');
                }

                cartTotal.innerText = '₹' + total.toFixed(2);
                cartCount.innerText = count;
                cartCount.classList.toggle('hidden', count === 0);
            }

            window.toggleCart = function () {
                const modal = document.getElementById('cartModal');
                const content = document.getElementById('cartContent');
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    // Small delay for transition
                    setTimeout(() => {
                        content.classList.remove('translate-x-full');
                    }, 10);
                } else {
                    content.classList.add('translate-x-full');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                }
            }

            // Order Logic (Firestore)
            window.placeOrder = async function () {
                const entries = Object.values(cart);
                if (entries.length === 0) {
                    showToast('Cart is empty!');
                    return;
                }

                const newOrder = {
                    client: currentUser.uid,
                    clientEmail: currentUser.email,
                    items: entries,
                    total: entries.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    status: 'Order Placed',
                    timestamp: new Date().toISOString()
                };

                try {
                    await placeOrderService(newOrder);

                    cart = {};
                    saveCart();
                    toggleCart(); // Ensure toggleCart is available
                    showToast('Order Placed Successfully!');
                    switchView('track');
                    await renderOrders();

                } catch (e) {
                    console.error(e);
                    showToast('Error placing order');
                }
            }

            window.renderOrders = async function () {
                const orders = await getOrders(currentUser.uid);
                // Filter client side for now as getOrders returns all
                // Ideally update getOrders to accept query
                // Temporarily filter by client ID match
                const myOrders = orders.filter(o => o.client === currentUser.uid).reverse();

                const activeOrders = myOrders.filter(o => o.status !== 'Delivered');
                const pastOrders = myOrders.filter(o => o.status === 'Delivered');

                const trackContainer = document.getElementById('trackOrderList');
                const historyContainer = document.getElementById('ordersList');

                if (activeOrders.length === 0) {
                    trackContainer.innerHTML = '<div class="text-center text-gray-400 py-8 bg-white rounded-xl shadow-sm">No active orders to track.</div>';
                } else {
                    trackContainer.innerHTML = activeOrders.map(order => createOrderCard(order)).join('');
                }

                if (pastOrders.length === 0) {
                    historyContainer.innerHTML = '<div class="text-center text-gray-400 py-8 bg-white rounded-xl shadow-sm">No past orders.</div>';
                } else {
                    historyContainer.innerHTML = pastOrders.map(order => createOrderCard(order)).join('');
                }
            }


            // Helper for Orders
            function createOrderCard(order) {
                return `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800">Order #${order.id.slice(0, 6)}</p>
                        <p class="text-sm text-gray-500">${new Date(order.timestamp).toLocaleString()}</p>
                        <p class="text-xs text-brand-red font-semibold mt-1">${order.status}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-brand-red">₹${order.total.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${order.items.length} Items</p>
                    </div>
                </div>
            `;
            }

        })();
    </script>
</body>

</html>